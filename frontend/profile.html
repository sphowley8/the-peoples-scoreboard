<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net;
                 style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;
                 connect-src 'self' https://*.amazonaws.com https://*.amazoncognito.com;
                 font-src 'self' data:;
                 img-src 'self' data:;">
  <title>My Profile ‚Äî The People's Scoreboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="js/auth.js"></script>
  <style>
    [x-cloak] { display: none !important; }
  </style>
</head>
<body class="bg-gray-950 text-white min-h-screen flex flex-col">

  <!-- Nav -->
  <nav class="w-full px-6 py-4 flex items-center justify-between border-b border-gray-800">
    <a href="/" class="text-xl font-bold tracking-tight text-white hover:text-indigo-400 transition">
      üó≥Ô∏è The People's Scoreboard
    </a>
    <button onclick="logout()"
            class="px-4 py-2 rounded-lg bg-gray-800 hover:bg-gray-700 text-sm font-semibold transition">
      Sign Out
    </button>
  </nav>

  <!-- Profile Content -->
  <main class="flex-1 flex flex-col items-center px-6 py-16 gap-10"
        x-data="profilePage()"
        x-init="init()"
        x-cloak>

    <!-- Redirect if not logged in -->
    <template x-if="!loggedIn">
      <div class="text-gray-400">
        You must be signed in to view this page.
        <a :href="loginUrl" class="text-indigo-400 underline ml-1">Sign in</a>
      </div>
    </template>

    <template x-if="loggedIn">
      <div class="w-full max-w-2xl flex flex-col gap-8">

        <!-- Avatar + Name -->
        <div class="flex items-center gap-6">
          <div class="w-20 h-20 rounded-full bg-indigo-600 flex items-center justify-center text-3xl font-black"
               x-text="initials"></div>
          <div>
            <h1 class="text-3xl font-extrabold" x-text="email"></h1>
            <p class="text-gray-500 text-sm mt-1">Member since <span x-text="memberSince"></span></p>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="bg-gray-900 rounded-2xl p-6 flex flex-col gap-1 border border-gray-800">
            <p class="text-4xl font-black text-indigo-400" x-text="stats.totalClicks">‚Äî</p>
            <p class="text-sm text-gray-500">Total Unsubscribes</p>
          </div>
          <div class="bg-gray-900 rounded-2xl p-6 flex flex-col gap-1 border border-gray-800">
            <p class="text-4xl font-black text-green-400" x-text="stats.rank">‚Äî</p>
            <p class="text-sm text-gray-500">Global Rank</p>
          </div>
        </div>

        <!-- My Campaign -->
        <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-800">
            <h2 class="font-bold text-lg">My Campaign</h2>
            <p class="text-xs text-gray-500 mt-0.5">Share your link ‚Äî every action taken by someone who arrives via it counts toward your campaign on the leaderboard.</p>
          </div>

          <!-- Loading state -->
          <template x-if="campaign.loading">
            <p class="px-6 py-6 text-gray-600 text-sm">Loading‚Ä¶</p>
          </template>

          <!-- Has campaign -->
          <template x-if="!campaign.loading && campaign.id">
            <div class="px-6 py-5 flex flex-col gap-3">
              <p class="text-sm text-gray-400">Campaign name: <span class="text-white font-semibold" x-text="campaign.name"></span></p>
              <div class="flex items-center gap-2">
                <input type="text" readonly
                       :value="campaign.shareUrl"
                       class="flex-1 px-3 py-2 bg-gray-800 border border-gray-700 text-xs text-gray-300 rounded focus:outline-none" />
                <button @click="copyCampaignLink()"
                        class="px-4 py-2 bg-[#ffed61] text-gray-950 text-xs font-black uppercase tracking-wider hover:bg-[#fff9a0] transition rounded">
                  <span x-show="!campaign.copied">Copy</span>
                  <span x-show="campaign.copied">Copied!</span>
                </button>
              </div>
            </div>
          </template>

          <!-- No campaign yet -->
          <template x-if="!campaign.loading && !campaign.id">
            <div class="px-6 py-5 flex flex-col gap-3">
              <p class="text-sm text-gray-400">You don't have a campaign yet. Create one to get your personal share link.</p>
              <form @submit.prevent="createCampaign()" class="flex flex-col gap-3">
                <input type="text"
                       x-model="campaign.newName"
                       maxlength="32"
                       placeholder="Campaign name (max 32 chars)"
                       class="w-full px-3 py-2 bg-gray-800 border border-gray-700 text-sm text-white placeholder-gray-600 rounded focus:outline-none focus:border-indigo-500 transition" />
                <p x-show="campaign.error" x-text="campaign.error" class="text-red-400 text-xs"></p>
                <button type="submit" :disabled="campaign.creating"
                        class="px-4 py-2 bg-[#ffed61] text-gray-950 text-xs font-black uppercase tracking-wider hover:bg-[#fff9a0] transition rounded disabled:opacity-50 disabled:cursor-not-allowed">
                  <span x-show="!campaign.creating">Create Campaign ‚Üí</span>
                  <span x-show="campaign.creating">Creating‚Ä¶</span>
                </button>
              </form>
            </div>
          </template>
        </div>

      </div>
    </template>

  </main>

  <!-- Footer -->
  <footer class="py-6 text-center text-xs text-gray-700 border-t border-gray-900">
    The People's Scoreboard &copy; 2025 ‚Äî Built for accountability.
  </footer>

  <script>
    function profilePage() {
      return {
        loggedIn:    isLoggedIn(),
        loginUrl:    'login.html',
        email:       "",
        initials:    "",
        memberSince: "",
        stats: {
          totalClicks: "‚Ä¶",
          rank:        "‚Äî",
          streak:      "‚Äî",
        },
        activity: [],

        campaign: {
          loading:  true,
          id:       null,
          name:     "",
          shareUrl: "",
          newName:  "",
          creating: false,
          copied:   false,
          error:    "",
        },

        async init() {
          if (!this.loggedIn) return;

          const user = getCurrentUser();
          this.email    = user?.email ?? "User";
          this.initials = this.email.slice(0, 2).toUpperCase();

          const createdAt = user?.["custom:created_at"] || user?.iat;
          this.memberSince = createdAt
            ? new Date(createdAt * 1000).toLocaleDateString("en-US", { month: "long", year: "numeric" })
            : "Unknown";

          // Fetch user activity and campaign in parallel
          await Promise.all([
            this.loadActivity(),
            this.loadCampaign(),
          ]);
        },

        async loadActivity() {
          try {
            const res = await fetch(`${CONFIG.apiEndpoint}/user-activity?limit=20`, {
              headers: { "Authorization": getIdToken() },
            });
            const data = await res.json();
            this.activity = data.items ?? [];
            this.stats.totalClicks = data.count ?? 0;
          } catch {
            this.activity = [];
          }
        },

        async loadCampaign() {
          try {
            const res = await fetch(`${CONFIG.apiEndpoint}/campaign`, {
              headers: { "Authorization": getIdToken() },
            });
            if (res.ok) {
              const data = await res.json();
              this.campaign.id       = data.campaign_id;
              this.campaign.name     = data.campaign_name;
              this.campaign.shareUrl = data.share_url;
            }
            // 404 = no campaign yet ‚Äî leave id as null
          } catch {
            // network error ‚Äî leave loading state cleared, id null
          } finally {
            this.campaign.loading = false;
          }
        },

        async createCampaign() {
          this.campaign.error = "";
          const name = this.campaign.newName.trim();
          if (!name) {
            this.campaign.error = "Please enter a campaign name.";
            return;
          }
          this.campaign.creating = true;
          try {
            const res = await fetch(`${CONFIG.apiEndpoint}/campaign`, {
              method:  "POST",
              headers: {
                "Authorization": getIdToken(),
                "Content-Type":  "application/json",
              },
              body: JSON.stringify({ campaign_name: name }),
            });
            const data = await res.json();
            if (!res.ok) {
              this.campaign.error = data.error || "Failed to create campaign.";
              return;
            }
            this.campaign.id       = data.campaign_id;
            this.campaign.name     = data.campaign_name;
            this.campaign.shareUrl = data.share_url;
          } catch {
            this.campaign.error = "Network error ‚Äî please try again.";
          } finally {
            this.campaign.creating = false;
          }
        },

        async copyCampaignLink() {
          try {
            await navigator.clipboard.writeText(this.campaign.shareUrl);
            this.campaign.copied = true;
            setTimeout(() => { this.campaign.copied = false; }, 2000);
          } catch {
            // Fallback: select the input text
            const input = document.querySelector('input[readonly]');
            if (input) { input.select(); document.execCommand('copy'); }
          }
        },

        formatDate(ts) {
          return new Date(ts).toLocaleDateString("en-US", {
            month: "short", day: "numeric", year: "numeric",
          });
        },
      };
    }
  </script>

</body>
</html>
